# Nginx Rate Limiting Configuration for JustType
# Add this to your nginx.conf or include it in your server block

# Define rate limit zones (outside server block, in http block)
# These should go in /etc/nginx/nginx.conf in the http { } section

limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=public_limit:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=2r/s;

# Then in your server block for justtype.io:

server {
    server_name justtype.io www.justtype.io;

    # ... your existing SSL and proxy config ...

    # API endpoints (general) - 10 requests/sec with burst of 20
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://localhost:3003;
        # ... rest of your proxy config ...
    }

    # Auth endpoints (stricter) - 2 requests/sec with burst of 5
    location /api/auth/ {
        limit_req zone=auth_limit burst=5 nodelay;
        proxy_pass http://localhost:3003;
        # ... rest of your proxy config ...
    }

    # Admin endpoints (very strict) - 1 request/sec with burst of 5
    location ~ ^/api/admin {
        limit_req zone=admin_limit burst=5 nodelay;
        proxy_pass http://localhost:3003;
        # ... rest of your proxy config ...
    }

    # Admin console page (same limits as admin API)
    location /holyfuckwhereami {
        limit_req zone=admin_limit burst=5 nodelay;
        proxy_pass http://localhost:3003;
        # ... rest of your proxy config ...
    }

    # Public slates (generous) - 30 requests/sec with burst of 50
    location /s/ {
        limit_req zone=public_limit burst=50 nodelay;
        proxy_pass http://localhost:3003;
        # ... rest of your proxy config ...
    }

    # Static files (no rate limit, handled by CDN later)
    location / {
        proxy_pass http://localhost:3003;
        # ... rest of your proxy config ...
    }
}

# Installation Instructions:
#
# 1. Add the limit_req_zone lines to /etc/nginx/nginx.conf in the http { } block
#    (before any server blocks)
#
# 2. Add the location blocks to your existing justtype.io server block in
#    /etc/nginx/sites-available/justtype (or wherever your config is)
#
# 3. Test the configuration:
#    sudo nginx -t
#
# 4. If test passes, reload nginx:
#    sudo systemctl reload nginx
#
# 5. Monitor logs for rate limit hits:
#    sudo tail -f /var/log/nginx/error.log | grep limiting
#
# Notes:
# - "burst" allows temporary spikes (e.g., user rapidly clicking)
# - "nodelay" processes burst requests immediately (no queuing)
# - Adjust rates if you see legitimate users getting blocked
# - Rate limits are per IP address ($binary_remote_addr)
